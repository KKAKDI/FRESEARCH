<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.fs.mapper.StatsMapper">

<select id="getList" resultType="org.fs.domain.StatsVO">
<![CDATA[
select SUBJ_CODE as subjCode ,CTGR_CODE as ctgrCode, MB_EMAIL as mbEmail, MB_NICK as mbNick, SUBJ_NM as subjNm, SUBJ_REGDATE as subjRegdate, SUBJ_STARTDATE as subjStartDate, SUBJ_ENDDATE as subjEndDate from subject
]]>
</select>

<select id="getMemberList" resultType="org.fs.domain.StatsVO">	<!-- MEMBER 테이블에서 전체 싹 뽑는 SQL문 -->
select MB_ATT_CTGR_CODE as mbAttCtgrCode, MB_PWD as mbPwd, MB_ADDR as mbAddr, MB_BIRTHDATE as mbBirthDate, MB_SEX as mbSex, MB_PHONE as mbPhone, MB_REG_ATRT as mbRegAtrt, MB_JOINDATE as mbJoinDate from member
</select>

 
<select id="getAttCategory" resultType="org.fs.domain.StatsVO">	<!-- ATT_CATEGORY에서 전체 싹 뽑는 SQL문 -->
select MB_ATT_CTGR_CODE as bmAttCtgrCode, MB_EMAIL as mbEmail, CTGR_CODE1 as ctgrCode1, CTGR_CODE2 as ctgrCode2, CTGR_CODE3 as ctgrCode3, CTGR_CODE5 as ctgrCode5, MB_MARRIAGE_YN as mbMarriageYn,MB_CHILD_YN as mbChildYn,MB_HOME_YN as mbHomeYn,MB_CAR_YN as mbCarYn from ATT_CATEGORY 
</select>

<select id="getCategory" resultType="org.fs.domain.StatsVO">	<!-- 카테고리별 갯수,퍼센트 구하는 SQL문  -->
select (select count(*) from (select * from area where substr(MB_ADDR,1 , 5) like '%'||#{area}||'%') where CTGR_CODE = c.CTGR_CODE)as count, c.CTGR_CODE,
round((ratio_to_report((select count(*) as num from (select * from area where substr(MB_ADDR,1 , 5) like '%'||#{area}||'%') where CTGR_CODE =
(select  CTGR_CODE from category where CTGR_CODE = c.CTGR_CODE))) over()*100),2)||'%' percent
,c.CTGR_NM from subject a , member b, category c where a.MB_NICK = b.MB_NICK and c.CTGR_CODE = a.CTGR_CODE  
<!--and substr(b.MB_ADDR, 1, 5) like '%'||#{area}||'%'--> group by c.CTGR_CODE, c.CTGR_NM order by CTGR_CODE
</select>

<select id="getCategoryAge" parameterType="map" resultType="org.fs.domain.StatsVO">
select (select count(*) from (select * from (select c.CTGR_CODE,c.CTGR_NM, b.MB_NICK, b.MB_ADDR, b.MB_BIRTHDATE
from subject a , member b, category c where a.MB_NICK = b.MB_NICK and c.CTGR_CODE = a.CTGR_CODE)
where NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(MB_BIRTHDATE, 1, 4), 'YYYY'))/12), 0)between #{startAge} and #{endAge})
where CTGR_CODE = c.CTGR_CODE)as count,
c.CTGR_CODE, c.CTGR_NM,
round((ratio_to_report((select count(*) as num from (select * from area where NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(MB_BIRTHDATE, 1, 4), 'YYYY'))/12), 0)between #{startAge} and #{endAge}) where CTGR_CODE =
(select  CTGR_CODE from category where CTGR_CODE = c.CTGR_CODE))) over()*100),2)||'%' percent
from subject a , member b, category c where a.MB_NICK = b.MB_NICK and c.CTGR_CODE = a.CTGR_CODE  
group by c.CTGR_CODE, c.CTGR_NM order by CTGR_CODE 
</select>

<select id="getCategorySex" resultType="org.fs.domain.StatsVO">
select (select count(*) from (select * from (select c.CTGR_CODE,c.CTGR_NM, b.MB_NICK, b.MB_ADDR, b.MB_BIRTHDATE, b.MB_Sex
from subject a , member b, category c where a.MB_NICK = b.MB_NICK and c.CTGR_CODE = a.CTGR_CODE)
where MB_SEX = #{sex}) where CTGR_CODE = c.CTGR_CODE)as count,
c.CTGR_CODE, c.CTGR_NM,
round((ratio_to_report((select count(*) as num from 
(select * from area where MB_SEX = #{sex}) where CTGR_CODE =
(select  CTGR_CODE from category where CTGR_CODE = c.CTGR_CODE))) over()*100),2)||'%' percent
from subject a , member b, category c where a.MB_NICK = b.MB_NICK and c.CTGR_CODE = a.CTGR_CODE  
group by c.CTGR_CODE, c.CTGR_NM order by CTGR_CODE
</select>

<select id="getCategoryMarriage" resultType="org.fs.domain.StatsVO">
select (select count(*) from (select * from area
where MB_MARRIAGE_YN = #{marriage}) where CTGR_CODE = c.CTGR_CODE)as count,
c.CTGR_CODE, c.CTGR_NM,
round((ratio_to_report((select count(*) as num from 
(select * from area where MB_MARRIAGE_YN = #{marriage}) where CTGR_CODE =
(select  CTGR_CODE from category where CTGR_CODE = c.CTGR_CODE))) over()*100),2)||'%' percent
from subject a , member b, category c where a.MB_NICK = b.MB_NICK and c.CTGR_CODE = a.CTGR_CODE  
group by c.CTGR_CODE, c.CTGR_NM order by CTGR_CODE
</select>
<!-- 
<select id="getTable" resultType="org.fs.domain.StatsVO">

SELECT (SELECT Count(*)
        FROM   (SELECT *
                FROM   answer)
        WHERE  item_code = e.item_code) AS answer_number,
       b.subj_regdate,
       f.ctgr_nm,
       a.mb_nick,
       c.qst_img,
       b.subj_nm,
       b.subj_startdate,
       b.subj_enddate
FROM   member a,
       subject b,
       question c,
       item d,
       answer e,
       category f
WHERE  b.mb_email = a.mb_email
       AND b.subj_code = c.subj_code
       AND c.qst_code = d.qst_code
       AND d.item_code = e.item_code
       AND f.ctgr_code = b.ctgr_code
       AND CTGR_NM like '%'||#{ctgr_nm}||'%'
       AND a.MB_SEX like '%'|| #{mbSex}||'%'
       AND substr(a.MB_ADDR,1 , 5) like '%'||#{mbAddr}||'%'
       AND NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(MB_BIRTHDATE, 1, 4), 'YYYY'))/12), 0)between #{startAge} and #{endAge}
      	 <choose>
      		<when test="stats == '전체'">
       		</when>
       		
       		<when test="stats == '대기'">
      			<![CDATA[ AND SUBJ_STARTDATE > to_char(sysdate,'yy/mm/dd') ]]>
      		</when>
      		
       		<when test="stats == '진행중'"> 
	   			<![CDATA[ AND subj_startdate <= to_char(sysdate, 'yy/mm/dd') AND subj_enddate > to_char(sysdate,'yy/mm/dd') ]]>
	   		</when>
	   		
	   		<when test="stats == '완료'">
	   			<![CDATA[ AND subj_enddate <= to_char(sysdate,'yy/mm/dd') ]]>
	   		</when>
	   		
	   	</choose>
group by b.subj_nm, b.subj_regdate, f.ctgr_nm, a.mb_nick, c.qst_img, b.subj_startdate, b.subj_enddate, e.item_code
 -->
 
 
<select id="getTable" resultType="org.fs.domain.StatsVO">
SELECT rownum, 
       answer_number, 
       subj_regdate, 
       subj_code, 
       ctgr_nm, 
       mb_nick, 
       mb_sex, 
       mb_birthdate, 
       mb_addr, 
       qst_img, 
       subj_nm, 
       subj_startdate, 
       subj_enddate 
FROM   (SELECT answer_number, 
               subj_regdate, 
               subj_code, 
               ctgr_nm, 
               mb_nick, 
               mb_sex, 
               mb_birthdate, 
               mb_addr, 
               qst_img, 
               subj_nm, 
               subj_startdate, 
               subj_enddate 
        FROM   stats_table 
        WHERE  ctgr_nm LIKE '%'||#{ctgr_nm}||'%'
               AND mb_sex LIKE '%'|| #{mbSex}||'%' 
               AND Substr(mb_addr, 1, 5) LIKE '%'||#{mbAddr}||'%' 
               AND Nvl(Trunc(Months_between(sysdate, To_date(Substr(mb_birthdate, 1, 4), 'YYYY')) /12), 0)BETWEEN #{startAge} AND #{endAge}
               <choose>
      				<when test="stats == '전체'">
       				</when>
       		
       				<when test="stats == '대기'">
      						<![CDATA[ AND SUBJ_STARTDATE > to_char(sysdate,'yy/mm/dd') ]]>
      				</when>
      		
       				<when test="stats == '진행중'"> 
	   						<![CDATA[ AND subj_startdate <= to_char(sysdate, 'yy/mm/dd') AND subj_enddate > to_char(sysdate,'yy/mm/dd') ]]>
	   				</when>
	   		
	   				<when test="stats == '완료'">
	   						<![CDATA[ AND subj_enddate <= to_char(sysdate,'yy/mm/dd') ]]>
	   				</when>
	   		 
	   		
			   	</choose>
	   		ORDER  BY subj_code)
</select>


<select id="getAge" resultType="org.fs.domain.StatsVO">	<!-- 멤버 테이블에서 나이 구하는 SQL문 -->
SELECT NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(MB_BIRTHDATE, 1, 4), 'YYYY'))/12), 0) as age FROM member
</select>

<select id="getAddr" resultType="int">		<!--  주소 구하는 SQL문 -->
select count(*) from (select MB_ADDR from member where  SUBSTR(MB_ADDR, 1,5) like '%'||#{addr}||'%')
</select>

<!--  <select id="getAddr" resultType="int">
select count(*) from (select MB_ADDR from member where  MB_ADDR like '%서울%')

</select>-->



</mapper>