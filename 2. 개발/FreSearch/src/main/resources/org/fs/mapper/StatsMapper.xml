<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.fs.mapper.StatsMapper">

<select id="getList" resultType="org.fs.domain.StatsVO">
<![CDATA[
select SUBJ_CODE, CTGR_CODE, MB_EMAIL, MB_NICK, SUBJ_NM, SUBJ_REGDATE, SUBJ_STARTDATE, SUBJ_ENDDATE from subject
]]>
</select>

<select id="getMemberList" resultType="org.fs.domain.StatsVO">	<!-- MEMBER 테이블에서 전체 싹 뽑는 SQL문 -->
SELECT mb_att_ctgr_code, 
       mb_pwd, 
       mb_addr, 
       mb_birthdate, 
       mb_sex, 
       mb_phone, 
       mb_reg_atrt, 
       mb_joindate 
FROM   member 
</select>

 
<select id="getAttCategory" resultType="org.fs.domain.StatsVO">	<!-- ATT_CATEGORY에서 전체 싹 뽑는 SQL문 -->
SELECT mb_att_ctgr_code, 
       mb_email, 
       ctgr_code1, 
       ctgr_code2, 
       ctgr_code3, 
       ctgr_code5, 
       mb_marriage_yn, 
       mb_child_yn, 
       mb_home_yn, 
       mb_car_yn 
FROM   att_category  
</select>

<select id="getCategory" resultType="org.fs.domain.StatsVO">	<!-- 카테고리별 갯수,퍼센트 구하는 SQL문  -->
SELECT (SELECT Count(*) 
        FROM   (SELECT * 
                FROM   area 
                WHERE  Substr(mb_addr, 1, 5) LIKE '%' || #{area} || '%') 
        WHERE  ctgr_code = c.ctgr_code)AS count, 
       c.ctgr_code, 
       Round(( Ratio_to_report((SELECT Count(*) AS num 
                                FROM   (SELECT * 
                                        FROM   area 
                                        WHERE  Substr(mb_addr, 1, 5) LIKE '%' || #{area} || '%') 
                                WHERE  ctgr_code = (SELECT ctgr_code 
                                                    FROM   category 
                                                    WHERE 
                                       ctgr_code = c.ctgr_code))) OVER() * 100 ), 2) || '%' PERCENT, 
       c.ctgr_nm 
FROM   subject a, 
       member b, 
       category c 
WHERE  a.mb_nick = b.mb_nick 
       AND c.ctgr_code = a.ctgr_code 
GROUP  BY c.ctgr_code, 
          c.ctgr_nm 
ORDER  BY ctgr_code 
</select>

<select id="getCategoryAge" parameterType="map" resultType="org.fs.domain.StatsVO">
SELECT (SELECT Count(*) 
        FROM   (SELECT * 
                FROM   (SELECT c.ctgr_code, 
                               c.ctgr_nm, 
                               b.mb_nick, 
                               b.mb_addr, 
                               b.mb_birthdate 
                        FROM   subject a, 
                               member b, 
                               category c 
                        WHERE  a.mb_nick = b.mb_nick 
                               AND c.ctgr_code = a.ctgr_code) 
                WHERE  Nvl(Trunc(Months_between(sysdate, To_date(Substr(mb_birthdate, 1, 4), 'YYYY')) /12), 0)BETWEEN #{startAge} AND #{endAge}) 
        WHERE  ctgr_code = c.ctgr_code)AS count, 
       c.ctgr_code, 
       c.ctgr_nm, 
       Round(( Ratio_to_report((SELECT Count(*) AS num 
                                FROM   (SELECT * 
                                        FROM   area 
                                        WHERE  Nvl(Trunc(Months_between(sysdate,To_date(Substr(mb_birthdate, 1, 4),'YYYY')) / 12), 0)BETWEEN #{startAge} AND #{endAge}) 
                                WHERE  ctgr_code = (SELECT ctgr_code 
                                                    FROM   category 
                                                    WHERE 
                                       ctgr_code = c.ctgr_code)))OVER() * 100 ), 2) || '%' PERCENT 
FROM   subject a, 
       member b, 
       category c 
WHERE  a.mb_nick = b.mb_nick 
       AND c.ctgr_code = a.ctgr_code 
GROUP  BY c.ctgr_code, 
          c.ctgr_nm 
ORDER  BY ctgr_code 
</select>

<select id="getCategorySex" resultType="org.fs.domain.StatsVO">
SELECT (SELECT Count(*) 
        FROM   (SELECT * 
                FROM   (SELECT c.ctgr_code, 
                               c.ctgr_nm, 
                               b.mb_nick, 
                               b.mb_addr, 
                               b.mb_birthdate, 
                               b.mb_sex 
                        FROM   subject a, 
                               member b, 
                               category c 
                        WHERE  a.mb_nick = b.mb_nick 
                               AND c.ctgr_code = a.ctgr_code) 
                WHERE  mb_sex = #{sex}) 
        WHERE  ctgr_code = c.ctgr_code)AS count, 
       c.ctgr_code, 
       c.ctgr_nm, 
       Round(( Ratio_to_report((SELECT Count(*) AS num 
                                FROM   (SELECT * 
                                        FROM   area 
                                        WHERE  mb_sex = #{sex}) 
                                WHERE  ctgr_code = (SELECT ctgr_code 
                                                    FROM   category 
                                                    WHERE 
                                       ctgr_code = c.ctgr_code))) OVER() * 100 ), 2) || '%'  PERCENT 
FROM   subject a, 
       member b, 
       category c 
WHERE  a.mb_nick = b.mb_nick 
       AND c.ctgr_code = a.ctgr_code 
GROUP  BY c.ctgr_code, 
          c.ctgr_nm 
ORDER  BY ctgr_code 
</select>

<select id="getCategoryMarriage" resultType="org.fs.domain.StatsVO">
SELECT (SELECT Count(*) 
        FROM   (SELECT * 
                FROM   area 
                WHERE  mb_marriage_yn = #{marriage}) 
        WHERE  ctgr_code = c.ctgr_code)AS count, 
       c.ctgr_code, 
       c.ctgr_nm, 
       Round(( Ratio_to_report((SELECT Count(*) AS num 
                                FROM   (SELECT * 
                                        FROM   area 
                                        WHERE  mb_marriage_yn = #{marriage}) 
                                WHERE  ctgr_code = (SELECT ctgr_code 
                                                    FROM   category 
                                                    WHERE 
                                       ctgr_code = c.ctgr_code)))OVER() * 100 ), 2) || '%' PERCENT 
FROM   subject a, 
       member b, 
       category c 
WHERE  a.mb_nick = b.mb_nick 
       AND c.ctgr_code = a.ctgr_code 
GROUP  BY c.ctgr_code, 
          c.ctgr_nm 
ORDER  BY ctgr_code 
</select>
<!-- 
<select id="getTable" resultType="org.fs.domain.StatsVO">

SELECT (SELECT Count(*)
        FROM   (SELECT *
                FROM   answer)
        WHERE  item_code = e.item_code) AS answer_number,
       b.subj_regdate,
       f.ctgr_nm,
       a.mb_nick,
       c.qst_img,
       b.subj_nm,
       b.subj_startdate,
       b.subj_enddate
FROM   member a,
       subject b,
       question c,
       item d,
       answer e,
       category f
WHERE  b.mb_email = a.mb_email
       AND b.subj_code = c.subj_code
       AND c.qst_code = d.qst_code
       AND d.item_code = e.item_code
       AND f.ctgr_code = b.ctgr_code
       AND CTGR_NM like '%'||#{ctgr_nm}||'%'
       AND a.MB_SEX like '%'|| #{mbSex}||'%'
       AND substr(a.MB_ADDR,1 , 5) like '%'||#{mbAddr}||'%'
       AND NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(MB_BIRTHDATE, 1, 4), 'YYYY'))/12), 0)between #{startAge} and #{endAge}
      	 <choose>
      		<when test="stats == '전체'">
       		</when>
       		
       		<when test="stats == '대기'">
      			<![CDATA[ AND SUBJ_STARTDATE > to_char(sysdate,'yy/mm/dd') ]]>
      		</when>
      		
       		<when test="stats == '진행중'"> 
	   			<![CDATA[ AND subj_startdate <= to_char(sysdate, 'yy/mm/dd') AND subj_enddate > to_char(sysdate,'yy/mm/dd') ]]>
	   		</when>
	   		
	   		<when test="stats == '완료'">
	   			<![CDATA[ AND subj_enddate <= to_char(sysdate,'yy/mm/dd') ]]>
	   		</when>
	   		
	   	</choose>
group by b.subj_nm, b.subj_regdate, f.ctgr_nm, a.mb_nick, c.qst_img, b.subj_startdate, b.subj_enddate, e.item_code
 -->
 
 
<select id="getTable" resultType="org.fs.domain.StatsVO">
SELECT answer_number, 
       subj_regdate, 
       subj_code, 
       ctgr_nm, 
       mb_nick, 
       mb_sex, 
       mb_birthdate, 
       mb_addr, 
       qst_img, 
       subj_nm, 
       subj_startdate, 
       subj_enddate 
FROM   (SELECT rownum rn,
	 		   answer_number, 
               subj_regdate, 
               subj_code, 
               ctgr_nm, 
               mb_nick, 
               mb_sex, 
               mb_birthdate, 
               mb_addr, 
               qst_img, 
               subj_nm, 
               subj_startdate, 
               subj_enddate 
        FROM   stats_table 
        WHERE  ctgr_nm LIKE '%'||#{ctgr_nm}||'%'
               AND mb_sex LIKE '%'|| #{mb_sex}||'%' 
               AND Substr(mb_addr, 1, 5) LIKE '%'||#{mb_addr}||'%' 
               AND Nvl(Trunc(Months_between(sysdate, To_date(Substr(mb_birthdate, 1, 4), 'YYYY')) /12), 0)BETWEEN #{startAge} AND #{endAge}
               <choose>
      				<when test="stats == '전체'">
       				</when>
       		
       				<when test="stats == '대기'">
      						<![CDATA[ AND SUBJ_STARTDATE > to_char(sysdate,'yy/mm/dd') ]]>
      				</when>
      		
       				<when test="stats == '진행중'"> 
	   						<![CDATA[ AND subj_startdate <= to_char(sysdate, 'yy/mm/dd') AND subj_enddate > to_char(sysdate,'yy/mm/dd') ]]>
	   				</when>
	   		
	   				<when test="stats == '완료'">
	   						<![CDATA[ AND subj_enddate <= to_char(sysdate,'yy/mm/dd') ]]>
	   				</when>
	   				
			   	</choose>
			  <![CDATA[ 	
	   		  AND rownum <=10)
	   		  where rn >=1
	   		  ]]>
</select>


<select id="getTableTest" resultType="org.fs.domain.StatsVO">
SELECT answer_number, 
       subj_regdate, 
       subj_code, 
       ctgr_nm, 
       mb_nick, 
       mb_sex, 
       mb_birthdate, 
       mb_addr, 
       qst_img, 
       subj_nm, 
       subj_startdate, 
       subj_enddate 
FROM   (SELECT rownum rn,
	 		   answer_number, 
               subj_regdate, 
               subj_code, 
               ctgr_nm, 
               mb_nick, 
               mb_sex, 
               mb_birthdate, 
               mb_addr, 
               qst_img, 
               subj_nm, 
               subj_startdate, 
               subj_enddate 
        FROM   stats_table 
        WHERE  ctgr_nm LIKE '%'||#{vo.ctgr_nm}||'%'
               AND mb_sex LIKE '%'|| #{vo.mb_sex}||'%' 
               AND Substr(mb_addr, 1, 5) LIKE '%'||#{vo.mb_addr}||'%'  
               AND Nvl(Trunc(Months_between(sysdate, To_date(Substr(mb_birthdate, 1, 4), 'YYYY')) /12), 0)BETWEEN #{vo.startAge} AND #{vo.endAge}
              <choose>
              
      				<when test="vo.stats == '전체'.toString()">
       				</when>
       		
       				<when test="vo.stats == '대기'.toString()">
      						<![CDATA[ AND SUBJ_STARTDATE > to_char(sysdate,'yy/mm/dd') ]]>
      				</when>
      		
       				<when test="vo.stats == '진행중'.toString()"> 
	   						<![CDATA[ AND subj_startdate <= to_char(sysdate, 'yy/mm/dd') AND subj_enddate > to_char(sysdate,'yy/mm/dd') ]]>
	   				</when>
	   		
	   				<when test="vo.stats == '완료'.toString()">
	   						<![CDATA[ AND subj_enddate <= to_char(sysdate,'yy/mm/dd') ]]>
	   				</when>
	   				
			   	</choose>
			  <![CDATA[ 	
	   		  AND rownum <= #{cri.pageNum} * #{cri.amount})
	   		  where rn > (#{cri.pageNum} -1) * #{cri.amount}
	   		  ]]>
</select>




<select id="getAge" resultType="org.fs.domain.StatsVO">	<!-- 멤버 테이블에서 나이 구하는 SQL문 -->
SELECT Nvl(Trunc(Months_between(sysdate, To_date(Substr(mb_birthdate, 1, 4), 'YYYY')) /12), 0) AS age 
FROM   member 
</select>

<select id="getAddr" resultType="int">		<!--  주소 구하는 SQL문 -->
SELECT Count(*) 
FROM   (SELECT mb_addr
        FROM   member
        WHERE  Substr(mb_addr, 1, 5) LIKE '%' || #{addr}|| '%')
</select>

<!--  <select id="getAddr" resultType="int">
select count(*) from (select MB_ADDR from member where  MB_ADDR like '%서울%')

</select>-->



</mapper>